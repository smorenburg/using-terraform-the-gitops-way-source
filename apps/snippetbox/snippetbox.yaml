---
apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: snippetbox
  namespace: flux-system
spec:
  path: ./apps/snippetbox/terraform
  interval: 1m
  tfstate:
    forceUnlock: auto
  approvePlan: auto
  destroyResourcesOnDeletion: true
  sourceRef:
    kind: GitRepository
    name: flux-system
  runnerPodTemplate:
    metadata:
      labels:
        azure.workload.identity/use: "true"
    spec:
      env:
        - name: ARM_TENANT_ID
          value: 7ddc4c97-c5a0-4a29-ac83-59be0f280518
        - name: ARM_SUBSCRIPTION_ID
          value: ae9db8ac-2682-4a98-ad36-7d13b2bd5a24
        - name: ARM_CLIENT_ID
          value: 5a0f20fe-d335-45ca-8217-f1704d22d9ee
        - name: ARM_USE_OIDC
          value: "true"
        - name: ARM_OIDC_TOKEN_FILE_PATH
          value: /var/run/secrets/azure/tokens/azure-identity-token
  backendConfig:
    customConfiguration: |
      backend "azurerm" {
        resource_group_name  = "rg-tfstate-nordcloud-neu"
        storage_account_name = "stnordcloudn1hxyb"
        container_name       = "tfstate"
        key                  = "snippetbox.northeurope.tfstate"
        use_oidc             = true
      }
  vars:
    - name: resource_group
      value: rg-tfstate-nordcloud-neu
    - name: storage_account
      value: stnordcloudn1hxyb
    - name: container_image
      value: smorenburg/snippetbox:0.0.6
    - name: ingress_rule_host
      value: snippetbox.52.178.207.153.nip.io
